<%- include("../layouts/boilerplate") %>

<style>
  /* Reset and base styles */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
    background: #ffffff;
    min-height: 100vh;
    color: #000000;
  }
  /* Student registration button in top-right */
  .student-registration-form-link {
    position: absolute;
    top: 15px;
    right: 30px;
    z-index: 1000;
  }

  /* Top navigation bar */
  .navbar {
    background: #ffffff !important;
    padding: 5px 35px;
    border-bottom: 1px solid #e5e7eb;
    position: relative;
    align-items: row;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  /* Student registration button in top-right */
  .student-registration-form-link {
    position: absolute;
    top: 20px;
    right: 140px;
    margin-left: 30px;
    z-index: 1000;
  }

  #get-link {
    background: #6366f1;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #get-link:hover {
    background: #4f46e5;
  }

  a {
    text-decoration: none;
  }
</style>

<!-- Display flash messages -->
<% if (messages.error) { %>
<div style="color: red"><%= messages.error %></div>
<% } %> <% if (messages.success) { %>
<div style="color: green"><%= messages.success %></div>
<% } %>

<!-- Student registration button -->
<div class="student-registration-form-link">
  <form action="/collegeProfile/<%= college._id %>/get-link" method="post">
    <button
      type="submit"
      id="get-link"
      aria-label="Get student registration URL"
    >
      Get Registration Link
    </button>
  </form>
  <% if (messages.registrationLink) { %>
  <input
    type="hidden"
    id="registration-link"
    value="<%= messages.registrationLink %>"
  />
  <% } %>
</div>

<script>
  // Automatically copy the link if it exists on page load
  window.onload = function () {
    const linkInput = document.getElementById("registration-link");
    if (linbuttkInput) {
      navigator.clipboard
        .writeText(linkInput.value)
        .then(() => {
          console.log("Link copied to clipboard!");
        })
        .catch((err) => {
          console.error("Failed to copy link:", err);
        });
    }
  };
</script>

<main class="page">
  <section class="club-header" aria-labelledby="club-title">
    <div class="decor decor--radials" aria-hidden="true"></div>
    <div class="decor decor--grid" aria-hidden="true"></div>

    <div class="club-header__grid">
      <!-- Logo tile -->
      <button type="button" class="logo-tile" aria-label="Change college logo">
        <span class="logo-tile__glow" aria-hidden="true"></span>
        <span class="logo-tile__frame">
          <img
            src="<%= college.collegeLogo.url %>"
            alt="Logo of <%= college.college %>"
          />
        </span>
      </button>

      <!-- Copy -->
      <div class="club-copy">
        <h1 id="club-title" class="club-title"><%= college.college %></h1>
        <p class="club-desc">
          <b>Clubs:</b> <%= college.clubs ? college.clubs.length : 0 %>
        </p>
      </div>

      <!-- Actions -->
      <div class="actions">
        <!-- Desktop buttons -->
        <div class="actions__desktop" role="group" aria-label="College actions">
          <!-- Create Club -->
          <div class="tooltip-container">
            <button
              class="club-btn club-btn--primary"
              type="button"
              onclick="location.href='/clubRegistration'"
            >
              <!-- SVG -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="white"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M8 2v4"></path>
                <path d="M16 2v4"></path>
                <path
                  d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"
                ></path>
                <path d="M3 10h18"></path>
                <path d="M16 19h6"></path>
                <path d="M19 16v6"></path>
              </svg>
              <span class="action-btns">Create Club</span>
            </button>
            <span class="tooltip">Plan a club</span>
          </div>

          <!-- Edit -->
          <div class="tooltip-container">
            <button
              class="club-btn club-btn--outline"
              type="button"
              onclick="location.href='/college/edit/<%= college._id %>'"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                />
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                />
              </svg>
              <span>Edit</span>
            </button>
            <span class="tooltip">Edit college details</span>
          </div>

          <!-- Delete -->
          <div class="tooltip-container">
            <form
              id="deleteForm"
              action="/colleges/<%= college._id %>?_method=DELETE"
              method="post"
            >
              <button
                class="club-btn club-btn--destructive"
                type="button"
                onclick="confirmDeletion()"
              >
                <svg
                  class="icon icon--16 create-svg"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    d="M3 6h18M8 6V4h8v2M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                <span class="action-btns">Delete</span>
              </button>
            </form>
            <span class="tooltip">Delete this college</span>
          </div>
        </div>

        <!-- Mobile kebab menu -->
        <div
          class="actions__mobile"
          data-menu-root
          onclick="togglePopup(event)"
        >
          <button
            class="btn btn--outline btn--icon"
            type="button"
            id="mobile-menu-button"
            aria-haspopup="menu"
            aria-expanded="false"
            aria-controls="mobile-menu"
            aria-label="Open actions menu"
          >
            <svg class="icon icon--20" viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="12" cy="5" r="1.5" fill="currentColor" />
              <circle cx="12" cy="12" r="1.5" fill="currentColor" />
              <circle cx="12" cy="19" r="1.5" fill="currentColor" />
            </svg>
            <span class="sr-only">More</span>
          </button>

          <div class="popup-menu" id="popupMenu">
            <a href="/clubRegistration" class="popup-item">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.2"
                stroke-linecap="round"
                stroke-linejoin="round"
                {...props}
              >
                <path d="M8 2v4"></path>
                <path d="M16 2v4"></path>
                <path
                  d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"
                ></path>
                <path d="M3 10h18"></path>
                <path d="M16 19h6"></path>
                <path d="M19 16v6"></path>
              </svg>
              <span>Create Club</span>
            </a>

            <a href="/college/edit/<%= college._id %>" class="popup-item">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                />
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                />
              </svg>
              <span>Edit</span>
            </a>

            <div class="divider"></div>

            <form
              id="deleteForm"
              action="/colleges/<%= college._id %>?_method=DELETE"
              method="POST"
            >
              <div
                class="popup-item delete"
                type="button"
                onclick="confirmDeletion()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <polyline points="3 6 5 6 21 6" />
                  <path
                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6
        m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                  />
                </svg>
                <span>Delete</span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Section for Clubs -->
  <section class="event-section">
    <div class="events-section">
      <div class="container">
        <div class="events-content">
          <div class="section-header">
            <h2 class="section-title">Clubs in <%= college.college %></h2>
            <p class="section-description">
              Explore all the active clubs in our college.
            </p>
          </div>

          <div class="events-grid">
            <% if (college.clubs && college.clubs.length > 0) { %> <%
            college.clubs.forEach(club => { %>
            <a href="/clubRegistration/login" class="club-navigation">
              <div class="event-card">
                <div class="card-image-container">
                  <img
                    src="<%= club.ClubLogo.url %>"
                    alt="Logo of <%= club.ClubName %>"
                    class="card-image"
                  />
                </div>
                <div class="card-content">
                  <h3 class="card-title"><%= club.ClubName %></h3>
                  <p class="card-description">
                    <strong>Total Events:</strong>
                    <%= club.events ? club.events.length : 0 %>
                  </p>
                </div>
              </div>
            </a>
            <% }); %> <% } else { %>
            <p class="no-events">No clubs available.</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<div
  id="confirmModal"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  "
>
  <div
    style="
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    "
  >
    <h4>Are you sure?</h4>
    <p>
      You are about to delete the college
      <strong><%= college.college %></strong>. This action cannot be undone.
    </p>
    <button onclick="submitForm()" class="btn btn-danger" style="margin: 5px">
      Yes, Delete
    </button>
    <button
      onclick="closeModal()"
      class="btn btn-secondary"
      style="margin: 5px"
    >
      Cancel
    </button>
  </div>
</div>

<script>
  // Function to copy link to clipboard

  function confirmDeletion() {
    document.getElementById("confirmModal").style.display = "flex";
  }
  function closeModal() {
    document.getElementById("confirmModal").style.display = "none";
  }
  function submitForm() {
    document.getElementById("deleteForm").submit();
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(
      () => {
        // Flash message is handled server-side
      },
      (err) => {
        console.error("Failed to copy: ", err);
        alert("Failed to copy link. Please try again.");
      }
    );
  }

  // Auto-copy link if present (runs on page load)
  window.onload = function () {
    const linkInput = document.getElementById("registration-link");
    if (linkInput && linkInput.value) {
      copyToClipboard(linkInput.value);
    }
  };

  function togglePopup(event) {
    event.stopPropagation(); // Prevent triggering outside click
    const popup = document.getElementById("popupMenu");
    popup.style.display = popup.style.display === "flex" ? "none" : "flex";
  }

  // Hide popup when clicking outside
  document.addEventListener("click", function (event) {
    const popup = document.getElementById("popupMenu");
    const icon = document.querySelector(".edit-icon");

    if (
      popup &&
      !popup.contains(event.target) &&
      !icon.contains(event.target)
    ) {
      popup.style.display = "none";
    }
  });

  window.addEventListener("DOMContentLoaded", () => {
    const linkInput = document.getElementById("registration-link");
    if (linkInput && linkInput.value) {
      navigator.clipboard
        .writeText(linkInput.value)
        .then(() => {
          console.log("Link copied to clipboard");
          // Optional toast/alert
          // alert("Registration link copied to clipboard!");
        })
        .catch((err) => {
          console.error("Failed to copy link:", err);
        });
    }
  });
</script>
